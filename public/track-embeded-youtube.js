let trackingStart = null;
let isTracking = false
videoInfo = null

const UNSTARTED_STATE = -1
const ENDED_STATE = 0
const PLAYING_STATE = 1
const PAUSED_STATE = 2

function getVideoLanguage(playerElement)
{
    const tracks = playerElement.getAudioTrack()?.captionTracks
    if (!tracks)
        throw new TypeError("Could not get player element")
    
    if (tracks.length === 0)
        return "unknown"
    if (tracks.length === 1)
        return tracks[0].languageCode

    const autoGeneratedTrack = tracks.find(track => track.kind === "asr");
    if (autoGeneratedTrack) 
        return autoGeneratedTrack.languageCode;
    else 
        return "unknown"
}

function startTracking()
{
    if (isTracking)
        return

    trackingStart = new Date();
    isTracking = true
    console.log("tracking video")
    
}

function stopTracking()
{
    if (!trackingStart)
        return
    if (!isTracking)
        return

    const time = (new Date - trackingStart) / 1000;
    trackingStart = null;
    const data = {
        id: videoInfo.id,
        time,
        language: videoInfo.language,
        description: videoInfo.title,
        inputType: "YOUTUBE"
    }

    window.postMessage({ type: 'addWatchTime', payload: data }, '*');
    isTracking = false
    console.log(`Video stopped - added ${time.toFixed(3)}s to tracker`)
}

function getVideoData(playerElement)
{
    const data = playerElement.getVideoData()
    const id = data.video_id
    const title = data.title
    const language = getVideoLanguage(playerElement)
    videoInfo = {id, title, language}
}

function videoStatePoll(playerElement)
{
    switch (playerElement.getPlayerState()) {
        case PLAYING_STATE:
            if (!videoInfo)
                getVideoData(playerElement)
            startTracking();
            break;
        case PAUSED_STATE:
            stopTracking()
            break;
        case ENDED_STATE:
            stopTracking()
            break;
    }
}

const hookInterval = setInterval(() => {
    const playerElement = document.getElementById('movie_player');
    
    if (playerElement && typeof playerElement.getPlayerState === 'function') 
    {
        clearInterval(hookInterval);
        setInterval(() => videoStatePoll(playerElement), 100)
    }
}, 500);

